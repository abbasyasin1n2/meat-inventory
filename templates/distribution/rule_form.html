{% extends "base.html" %}
{% block title %}{{ 'Edit' if rule else 'Add' }} Reorder Rule{% endblock %}
{% block content %}
<div class="content-card">
  <div class="card-title-with-button"><h4>{{ 'Edit' if rule else 'Add' }} Reorder Rule</h4></div>
  
  <!-- Information Box -->
  <div class="alert-card blue" style="margin-bottom: 16px;">
    <div class="alert-title"><i class="ti ti-info-circle"></i> Reorder Rule Guidelines</div>
    <div class="alert-item">• <strong>Min Qty</strong> should be <strong>greater than current stock</strong> to generate restock suggestions</div>
    <div class="alert-item">• <strong>Target Qty</strong> must be <strong>greater than Min Qty</strong></div>
    <div class="alert-item">• Suggestions appear when stock drops <strong>below Min Qty</strong></div>
  </div>
  
  <form method="post" style="max-width:520px;">
    <div class="input-field">
      <label>Product</label>
      <select class="browser-default" name="product_id" required id="product_select" onchange="updateStockInfo()">
        <option value="">Select product</option>
        {% for p in products %}
        <option value="{{ p.id }}" {% if rule and rule.product_id==p.id %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
      </select>
    </div>
    
    <!-- Current Stock Display -->
    <div id="stock_info" style="display: none; background: #f5f5f5; padding: 8px; border-radius: 4px; margin-bottom: 16px;">
      <strong>Current Stock: </strong><span id="current_stock_value">-</span>
    </div>
    
    <div class="input-field">
      <label for="min_qty">Min Qty (should be > current stock)</label>
      <input type="number" step="0.01" name="min_qty" id="min_qty" value="{{ rule.min_qty if rule else '' }}" required>
    </div>
    <div class="input-field">
      <label for="target_qty">Target Qty (should be > min qty)</label>
      <input type="number" step="0.01" name="target_qty" id="target_qty" value="{{ rule.target_qty if rule else '' }}" required>
    </div>
    <p>
      <label>
        <input type="checkbox" name="active" {% if not rule or rule.active %}checked{% endif %}>
        <span>Active</span>
      </label>
    </p>
    <div style="margin-top:12px;display:flex;gap:8px;">
      <button type="submit" class="btn">Save</button>
      <a class="btn grey" href="{{ url_for('distribution.list_reorder_rules') }}">Cancel</a>
    </div>
  </form>
</div>

<script>
// Product stock data (passed from backend)
const productStocks = {
  {% for p in products %}
  {{ p.id }}: "Loading...",
  {% endfor %}
};

function updateStockInfo() {
  const select = document.getElementById('product_select');
  const stockInfo = document.getElementById('stock_info');
  const stockValue = document.getElementById('current_stock_value');
  
  if (select.value) {
    stockInfo.style.display = 'block';
    stockValue.textContent = 'Loading...';
    
    // Fetch current stock via AJAX (simplified - just show placeholder for now)
    fetch(`/distribution/product-stock/${select.value}`)
      .then(response => response.json())
      .then(data => {
        stockValue.textContent = data.stock.toFixed(2);
      })
      .catch(() => {
        stockValue.textContent = 'Unable to load';
      });
  } else {
    stockInfo.style.display = 'none';
  }
}

// Initialize if editing existing rule
document.addEventListener('DOMContentLoaded', function() {
  if (document.getElementById('product_select').value) {
    updateStockInfo();
  }
});
</script>
{% endblock %}


