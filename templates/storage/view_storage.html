{% extends "base.html" %}

{% block title %}Storage Details - {{ storage.name }}{% endblock %}

{% block content %}
<div class="animate__animated animate__fadeIn">
    <!-- Storage Header -->
    <div class="session-header">
        <h1>{{ storage.name }}</h1>
        <p><strong>Type:</strong> {{ storage.location_type or 'N/A' }} &nbsp;&nbsp;&nbsp; <strong>Capacity:</strong> {{ storage.capacity or 'N/A' }} kg &nbsp;&nbsp;&nbsp; <strong>Description:</strong> {{ storage.description or 'No description' }}</p>
    </div>

    <!-- Sensor Monitoring Section -->
    <div class="row">
        <div class="col s12 m8">
            <div class="content-card">
                <div class="card-title-with-icon">
                    <h5><i class="ti ti-device-analytics" style="margin-right: 10px;"></i>Sensor Monitoring</h5>
                    <a class="btn-floating btn-small modal-trigger action-btn" href="#addSensorModal"><i class="ti ti-plus"></i></a>
                </div>
                
                {% if sensors %}
                <div class="responsive-table">
                    <table class="highlight">
                        <thead>
                            <tr>
                                <th>Sensor Type</th>
                                <th>Device ID</th>
                                <th>Status</th>
                                <th>Latest Temperature</th>
                                <th>Latest Humidity</th>
                                <th>Alert Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sensor in sensors %}
                            <tr>
                                <td>{{ sensor.sensor_type }}</td>
                                <td>{{ sensor.sensor_id }}</td>
                                <td>
                                    <span class="badge {% if sensor.status == 'active' %}green{% else %}grey{% endif %}">{{ sensor.status }}</span>
                                </td>
                                <td>
                                    {% for reading in latest_readings %}
                                        {% if reading.sensor_id == sensor.id %}
                                            <span class="{% if reading.temperature and (reading.temperature < -2 or reading.temperature > 4) %}red-text{% endif %}">
                                                {{ "%.1f"|format(reading.temperature) if reading.temperature else 'N/A' }}Â°C
                                            </span>
                                        {% endif %}
                                    {% endfor %}
                                </td>
                                <td>
                                    {% for reading in latest_readings %}
                                        {% if reading.sensor_id == sensor.id %}
                                            <span class="{% if reading.humidity and (reading.humidity < 85 or reading.humidity > 95) %}red-text{% endif %}">
                                                {{ "%.1f"|format(reading.humidity) if reading.humidity else 'N/A' }}%
                                            </span>
                                        {% endif %}
                                    {% endfor %}
                                </td>
                                <td>
                                    {% for reading in latest_readings %}
                                        {% if reading.sensor_id == sensor.id %}
                                            {% if reading.alert_status == 'normal' %}
                                                <span class="badge green">Normal</span>
                                            {% elif reading.alert_status == 'temperature_alert' %}
                                                <span class="badge red">Temp Alert</span>
                                            {% elif reading.alert_status == 'humidity_alert' %}
                                                <span class="badge orange">Humidity Alert</span>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                </td>
                                <td>
                                    <a href="{{ url_for('storage.sensor_readings', sensor_id=sensor.id) }}" class="btn-small waves-effect waves-light btn-edit" title="View History"><i class="ti ti-chart-line"></i></a>
                                    <a href="{{ url_for('storage.simulate_sensor_reading', sensor_id=sensor.id) }}" class="btn-small waves-effect waves-light btn-warning" title="Simulate Reading"><i class="ti ti-device-floppy"></i></a>
                                    <form id="delete-sensor-form-{{ sensor.id }}" action="{{ url_for('storage.delete_sensor_route', sensor_id=sensor.id) }}" method="post" style="display:inline;">
                                        <button type="button" class="btn-small waves-effect waves-light btn-warning" onclick="confirmDeleteSensor('{{ sensor.id }}')" title="Delete Sensor"><i class="ti ti-trash"></i></button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="center-align" style="padding: 40px;">
                    <i class="ti ti-device-analytics large grey-text" style="font-size: 4rem;"></i>
                    <h5>No Sensors Configured</h5>
                    <p>Add sensors to start monitoring this storage location.</p>
                    <a href="#addSensorModal" class="btn modal-trigger action-btn"><i class="ti ti-plus left"></i>Add First Sensor</a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Storage Info Card -->
        <div class="col s12 m4">
            <div class="content-card">
                <h5 class="card-title">Storage Information</h5>
                <div class="row">
                    <div class="col s12">
                        <p><strong>Name:</strong> {{ storage.name }}</p>
                        <p><strong>Type:</strong> {{ storage.location_type or 'N/A' }}</p>
                        <p><strong>Capacity:</strong> {{ storage.capacity or 'N/A' }} kg</p>
                        <p><strong>Description:</strong> {{ storage.description or 'No description' }}</p>
                        <p><strong>Created:</strong> {{ storage.created_at }}</p>
                        <p><strong>Sensors:</strong> {{ sensors|length }} configured</p>
                    </div>
                </div>
                <div class="row" style="margin-top: 20px;">
                    <div class="col s12">
                        <a href="{{ url_for('storage.edit_storage', id=storage.id) }}" class="btn waves-effect waves-light action-btn w-100"><i class="ti ti-edit left"></i>Edit Storage</a>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="content-card" style="margin-top: 20px;">
                <h5 class="card-title">Quick Actions</h5>
                <div class="row">
                    <div class="col s12">
                        <a href="{{ url_for('storage.list_storage') }}" class="btn waves-effect waves-light grey w-100"><i class="ti ti-arrow-left left"></i>Back to Storage List</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Sensor Modal -->
<div id="addSensorModal" class="modal modal-fixed-footer">
    <div class="modal-content">
        <h4>Add Sensor to {{ storage.name }}</h4>
        <form action="{{ url_for('storage.add_sensor', storage_id=storage.id) }}" method="post" id="addSensorForm">
            <div class="row">
                <div class="input-field col s6">
                    <i class="ti ti-device-analytics prefix"></i>
                    <select id="sensor_type" name="sensor_type" required>
                        <option value="" disabled selected>Choose sensor type</option>
                        <option value="Temperature">Temperature Sensor</option>
                        <option value="Humidity">Humidity Sensor</option>
                        <option value="Temperature_Humidity">Temperature & Humidity Sensor</option>
                        <option value="Environmental">Environmental Sensor</option>
                    </select>
                    <label>Sensor Type</label>
                </div>
                <div class="input-field col s6">
                    <i class="ti ti-device-floppy prefix"></i>
                    <input id="sensor_id" type="text" name="sensor_id" class="validate" required>
                    <label for="sensor_id">Device ID</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <i class="ti ti-toggle-left prefix"></i>
                    <select id="status" name="status">
                        <option value="active" selected>Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="maintenance">Maintenance</option>
                    </select>
                    <label>Status</label>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancel</a>
        <button type="submit" form="addSensorForm" class="btn waves-effect waves-light action-btn">Add Sensor</button>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Modals
        var modalElems = document.querySelectorAll('.modal');
        M.Modal.init(modalElems);

        // Initialize Selects inside modals
        var selectElems = document.querySelectorAll('select');
        M.FormSelect.init(selectElems);
    });

    function confirmDeleteSensor(id) {
        Swal.fire({
            title: 'Delete Sensor?',
            text: "This will also delete all sensor readings. You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('delete-sensor-form-' + id).submit();
            }
        })
    }
</script>
{% endblock %} 